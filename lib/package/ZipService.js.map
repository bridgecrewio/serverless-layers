{"version":3,"sources":["../../src/package/ZipService.js"],"names":["fs","require","path","chalk","mkdirp","crypto","fsExtra","archiver","MAX_LAYER_MB_SIZE","AbstractService","ZipService","hashName","functionName","Promise","resolve","reject","hash","createHash","input","createReadStream","on","chunk","update","digest","artifact","plugin","settings","mName","getManifestName","getChecksum","currentChecksum","bucketService","getFile","remoteChecksum","log","inverse","yellow","putFile","zipFileName","getPathZipFileName","compileDir","libraryFolder","runtimeDir","layersDir","join","process","cwd","shouldZipExternalLibraries","slsLayersConfig","shouldInstallPackages","externalLibrariesFolder","existsSync","Error","oldCwd","output","createWriteStream","zip","create","MB","pointer","toFixed","err","chdir","pipe","directory","progress","console","JSON","stringify","finalize","then","module","exports"],"mappings":";;;;;;;;;;;;;;;;;;AAAA,IAAMA,EAAE,GAAGC,OAAO,CAAC,IAAD,CAAlB;;AACA,IAAMC,IAAI,GAAGD,OAAO,CAAC,MAAD,CAApB;;AACA,IAAME,KAAK,GAAGF,OAAO,CAAC,OAAD,CAArB;;AACA,IAAMG,MAAM,GAAGH,OAAO,CAAC,QAAD,CAAtB;;AACA,IAAMI,MAAM,GAAGJ,OAAO,CAAC,QAAD,CAAtB;;AACA,IAAMK,OAAO,GAAGL,OAAO,CAAC,UAAD,CAAvB;;AACA,IAAMM,QAAQ,GAAGN,OAAO,CAAC,UAAD,CAAxB;;AAEA,IAAMO,iBAAiB,GAAG,GAA1B;;AAEA,IAAMC,eAAe,GAAGR,OAAO,CAAC,oBAAD,CAA/B;;IAEMS,U;;;;;;;;;;oCACYC,Q,EAAU;AACxB,uDAA0C,KAAKC,YAA/C;AACD;;;gCAEWV,I,EAAM;AAChB,aAAO,IAAIW,OAAJ,CAAY,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;AAC5C,YAAMC,IAAI,GAAGX,MAAM,CAACY,UAAP,CAAkB,KAAlB,CAAb;AACA,YAAMC,KAAK,GAAGlB,EAAE,CAACmB,gBAAH,CAAoBjB,IAApB,CAAd;AAEAgB,QAAAA,KAAK,CAACE,EAAN,CAAS,OAAT,EAAkBL,MAAlB;AAEAG,QAAAA,KAAK,CAACE,EAAN,CAAS,MAAT,EAAiB,UAAUC,KAAV,EAAiB;AAChCL,UAAAA,IAAI,CAACM,MAAL,CAAYD,KAAZ;AACD,SAFD;AAIAH,QAAAA,KAAK,CAACE,EAAN,CAAS,OAAT,EAAkB,YAAY;AAC5BN,UAAAA,OAAO,CAACE,IAAI,CAACO,MAAL,CAAY,KAAZ,CAAD,CAAP;AACD,SAFD;AAGD,OAbM,CAAP;AAcD;;;;;;;;;;AAGSC,gBAAAA,Q,GAAa,KAAKC,MAAL,CAAYC,Q,CAAzBF,Q;AACFG,gBAAAA,K,GAAQ,KAAKC,eAAL,CAAqBJ,QAArB,C;;uBAEgB,KAAKK,WAAL,CAAiBL,QAAjB,C;;;AAAxBM,gBAAAA,e;;uBACuB,KAAKL,MAAL,CAAYM,aAAZ,CAA0BC,OAA1B,CAAkCL,KAAlC,C;;;AAAvBM,gBAAAA,c;;sBAGFA,cAAc,KAAKH,e;;;;;iDACd,K;;;AAGT;AACA,qBAAKL,MAAL,CAAYS,GAAZ,WAAmB/B,KAAK,CAACgC,OAAN,CAAcC,MAAd,CAAqB,oBAArB,CAAnB,wBAA2EN,eAA3E;;uBACM,KAAKL,MAAL,CAAYM,aAAZ,CAA0BM,OAA1B,CAAkCV,KAAlC,EAAyCG,eAAzC,C;;;iDAEC,I;;;;;;;;;;;;;;;;;;+BAG+C;AAAA;;AAAA,UAAhDQ,WAAgD,uEAAlC,KAAKb,MAAL,CAAYc,kBAAZ,EAAkC;AAAA,kCACM,KAAKd,MAAL,CAAYC,QADlB;AAAA,UAC9Cc,UAD8C,yBAC9CA,UAD8C;AAAA,UAClChB,QADkC,yBAClCA,QADkC;AAAA,UACxBiB,aADwB,yBACxBA,aADwB;AAAA,UACTC,UADS,yBACTA,UADS,EAEtD;;AACA,UAAMC,SAAS,GAAGzC,IAAI,CAAC0C,IAAL,CAAUC,OAAO,CAACC,GAAR,EAAV,EAAyBN,UAAzB,CAAlB;AACA,UAAMO,0BAA0B,GAAG,CAAC,KAAKtB,MAAL,CAAYuB,eAAZ,CAA4BC,qBAAhE;AACA,UAAMC,uBAAuB,GAAGhD,IAAI,CAAC0C,IAAL,CAAUC,OAAO,CAACC,GAAR,EAAV,EAAyBL,aAAzB,CAAhC;AAEA,aAAO,IAAI5B,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC;AACA,YAAIS,QAAJ,EAAc;AACZ;AACA,cAAI,CAACxB,EAAE,CAACmD,UAAH,CAAcb,WAAd,CAAL,EAAiC;AAC/B,kBAAMc,KAAK,gCAAwBd,WAAxB,SAAX;AACD;;AACD,iBAAOxB,OAAO,EAAd;AACD;;AAED,YAAMuC,MAAM,GAAGR,OAAO,CAACC,GAAR,EAAf;AACA,YAAMQ,MAAM,GAAGtD,EAAE,CAACuD,iBAAH,CAAqBjB,WAArB,CAAf;AACA,YAAMkB,GAAG,GAAGjD,QAAQ,CAACkD,MAAT,CAAgB,KAAhB,CAAZ;AAEAH,QAAAA,MAAM,CAAClC,EAAP,CAAU,OAAV,EAAmB,YAAM;AACvB,cAAMsC,EAAE,GAAG,CAACF,GAAG,CAACG,OAAJ,KAAgB,IAAhB,GAAuB,IAAxB,EAA8BC,OAA9B,CAAsC,CAAtC,CAAX;;AAEA,cAAIF,EAAE,GAAGlD,iBAAT,EAA4B;AAC1B,YAAA,KAAI,CAACiB,MAAL,CAAYS,GAAZ,CAAgB,gBAAhB;;AACA,kBAAM,IAAIkB,KAAJ,CACJ,kFACA,uFAFI,CAAN;AAID;;AAED,UAAA,KAAI,CAAC3B,MAAL,CAAYS,GAAZ,iCAAyCI,WAAzC,eAAyDoB,EAAzD;;AACA5C,UAAAA,OAAO;AACR,SAbD;AAeA0C,QAAAA,GAAG,CAACpC,EAAJ,CAAO,OAAP,EAAgB,UAACyC,GAAD,EAAS;AACvB9C,UAAAA,MAAM,CAAC8C,GAAD,CAAN;AACAhB,UAAAA,OAAO,CAACiB,KAAR,CAAcT,MAAd;AACD,SAHD;AAKAR,QAAAA,OAAO,CAACiB,KAAR,CAAcnB,SAAd;AAEAa,QAAAA,GAAG,CAACO,IAAJ,CAAST,MAAT;AAEAE,QAAAA,GAAG,CAACQ,SAAJ,CAAc,QAAd,EAAwB,KAAxB;;AACA,YAAIjB,0BAAJ,EAAgC;AAC9BS,UAAAA,GAAG,CAACQ,SAAJ,CAAcd,uBAAd,EAAuChD,IAAI,CAAC0C,IAAL,CAAUF,UAAV,EAAsBD,aAAtB,CAAvC;AACD;;AAEDe,QAAAA,GAAG,CAACpC,EAAJ,CAAO,UAAP,EAAmB,UAAC6C,QAAD,EAAc;AAC/BC,UAAAA,OAAO,CAAChC,GAAR,CAAY,UAAZ;AACAgC,UAAAA,OAAO,CAAChC,GAAR,CAAYiC,IAAI,CAACC,SAAL,CAAeH,QAAf,CAAZ,EAF+B,CAEQ;AACxC,SAHD;AAIAT,QAAAA,GAAG,CAACa,QAAJ,GACGC,IADH,CACQ,YAAM;AACVzB,UAAAA,OAAO,CAACiB,KAAR,CAAcT,MAAd;AACD,SAHH;AAID,OAnDM,CAAP;AAoDD;;;EApGsB5C,e;;AAuGzB8D,MAAM,CAACC,OAAP,GAAiB9D,UAAjB","sourcesContent":["const fs = require('fs');\nconst path = require('path');\nconst chalk = require('chalk');\nconst mkdirp = require('mkdirp');\nconst crypto = require('crypto');\nconst fsExtra = require('fs-extra');\nconst archiver = require('archiver');\n\nconst MAX_LAYER_MB_SIZE = 250;\n\nconst AbstractService = require('../AbstractService');\n\nclass ZipService extends AbstractService {\n  getManifestName(hashName) {\n    return `__meta__/manifest-zip-artifact__${this.functionName}.json`;\n  }\n\n  getChecksum(path) {\n    return new Promise(function (resolve, reject) {\n      const hash = crypto.createHash('md5');\n      const input = fs.createReadStream(path);\n\n      input.on('error', reject);\n\n      input.on('data', function (chunk) {\n        hash.update(chunk);\n      });\n\n      input.on('close', function () {\n        resolve(hash.digest('hex'));\n      });\n    });\n  }\n\n  async hasZipChanged() {\n    const { artifact } = this.plugin.settings;\n    const mName = this.getManifestName(artifact);\n\n    const currentChecksum = await this.getChecksum(artifact);\n    const remoteChecksum = await this.plugin.bucketService.getFile(mName);\n\n    // check if zip hash changed\n    if (remoteChecksum === currentChecksum) {\n      return false;\n    }\n\n    // It updates remote check sum\n    this.plugin.log(`${chalk.inverse.yellow(' Artifact changed ')}! Checksum=${currentChecksum}`);\n    await this.plugin.bucketService.putFile(mName, currentChecksum);\n\n    return true;\n  }\n\n  package(zipFileName = this.plugin.getPathZipFileName()) {\n    const { compileDir, artifact, libraryFolder, runtimeDir } = this.plugin.settings;\n    // const zipFileName = this.plugin.getPathZipFileName();\n    const layersDir = path.join(process.cwd(), compileDir);\n    const shouldZipExternalLibraries = !this.plugin.slsLayersConfig.shouldInstallPackages;\n    const externalLibrariesFolder = path.join(process.cwd(), libraryFolder);\n\n    return new Promise((resolve, reject) => {\n      // it's a zip already\n      if (artifact) {\n        // It checks if file exists\n        if (!fs.existsSync(zipFileName)) {\n          throw Error(`Artifact not found \"${zipFileName}\".`);\n        }\n        return resolve();\n      }\n\n      const oldCwd = process.cwd();\n      const output = fs.createWriteStream(zipFileName);\n      const zip = archiver.create('zip');\n\n      output.on('close', () => {\n        const MB = (zip.pointer() / 1024 / 1024).toFixed(1);\n\n        if (MB > MAX_LAYER_MB_SIZE) {\n          this.plugin.log('Package error!');\n          throw new Error(\n            'Layers can\\'t exceed the unzipped deployment package size limit of 250 MB! \\n'\n          + 'Read more: https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html\\n\\n'\n          );\n        }\n\n        this.plugin.log(`Created layer package ${zipFileName} (${MB} MB)`);\n        resolve();\n      });\n\n      zip.on('error', (err) => {\n        reject(err);\n        process.chdir(oldCwd);\n      });\n\n      process.chdir(layersDir);\n\n      zip.pipe(output);\n\n      zip.directory('layers', false);\n      if (shouldZipExternalLibraries) {\n        zip.directory(externalLibrariesFolder, path.join(runtimeDir, libraryFolder));\n      }\n\n      zip.on('progress', (progress) => {\n        console.log('progress');\n        console.log(JSON.stringify(progress)); // TODO - remove!\n      });\n      zip.finalize()\n        .then(() => {\n          process.chdir(oldCwd);\n        });\n    });\n  }\n}\n\nmodule.exports = ZipService;\n"],"file":"ZipService.js"}
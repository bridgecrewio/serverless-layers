{"version":3,"sources":["../../src/runtimes/nodejs.js"],"names":["path","require","NodeJSRuntime","parent","runtime","runtimeDir","plugin","libraryFolder","packageManager","dependenciesPath","dependenciesLockPath","compatibleRuntimes","copyBeforeInstall","packageExclude","commands","npm","yarn","settings","localpackageJson","join","process","cwd","localpackageLockJson","localPackage","e","log","exit","localPackageLock","run","osVersion","match","runtimeVersion","version","isCompatible","startsWith","depsA","depsB","depsKeyA","Object","keys","depsKeyB","isSizeEqual","length","hasDifference","forEach","dependence","bucketService","downloadDependencesFile","remotePackage","isDifferent","parsedRemotePackage","JSON","parse","dependencies","isDiff","isDifferentPackageJson","isDifferentPackageLock","getFile","remotePackageLock","parsedRemotePackageLock","lockDependencies","fromEntries","entries","filter","dependency","dev","localLockDependencies","stringify","module","exports"],"mappings":"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","sourcesContent":["const path = require('path');\n\nclass NodeJSRuntime {\n  constructor(parent, runtime, runtimeDir) {\n    this.parent = parent;\n    this.plugin = parent.plugin;\n\n    this.default = {\n      runtime,\n      runtimeDir,\n      libraryFolder: 'node_modules',\n      packageManager:  'npm',\n      dependenciesPath: 'package.json',\n      dependenciesLockPath: 'package-lock.json',\n      compatibleRuntimes: [runtimeDir],\n      copyBeforeInstall: [\n        '.npmrc',\n        'yarn.lock',\n        'package-lock.json'\n      ],\n      packageExclude: [\n        'node_modules/**',\n      ]\n    };\n\n    this.commands = {\n      npm: 'npm install --production --only=prod',\n      yarn: 'yarn --production'\n    };\n  }\n\n  init() {\n    const { dependenciesPath, dependenciesLockPath } = this.plugin.settings;\n\n    const localpackageJson = path.join(\n      process.cwd(),\n      dependenciesPath\n    );\n\n    const localpackageLockJson = path.join(\n      process.cwd(),\n      dependenciesLockPath\n    );\n\n    try {\n      this.localPackage = require(localpackageJson);\n    } catch (e) {\n      this.plugin.log(`Error: Can not find ${localpackageJson} or ${localpackageLockJson}!`);\n      process.exit(1);\n    }\n\n    try {\n      this.localPackageLock = require(localpackageLockJson);\n      // eslint-disable-next-line no-empty\n    } catch (e) {}\n  }\n\n  async isCompatibleVersion(runtime) {\n    const osVersion = await this.parent.run('node --version');\n    const [runtimeVersion] = runtime.match(/([0-9]+)\\./);\n    return {\n      version: osVersion,\n      isCompatible: osVersion.startsWith(`v${runtimeVersion}`)\n    };\n  }\n\n  isDiff(depsA, depsB) {\n    if (!depsA) {\n      return true;\n    }\n\n    const depsKeyA = Object.keys(depsA);\n    const depsKeyB = Object.keys(depsB);\n    const isSizeEqual = depsKeyA.length === depsKeyB.length;\n\n    if (!isSizeEqual) return true;\n\n    let hasDifference = false;\n    Object.keys(depsA).forEach(dependence => {\n      if (depsA[dependence] !== depsB[dependence]) {\n        hasDifference = true;\n      }\n    });\n\n    return hasDifference;\n  }\n\n  async hasDependenciesChanges() {\n    const remotePackage = await this.plugin.bucketService.downloadDependencesFile();\n\n    let isDifferent = true;\n\n    if (remotePackage) {\n      const parsedRemotePackage = JSON.parse(remotePackage);\n      const { dependencies, version } = parsedRemotePackage;\n      this.plugin.log('Comparing package.json dependencies...');\n      const isDifferentPackageJson = await\n      this.isDiff(dependencies, this.localPackage.dependencies);\n\n      let isDifferentPackageLock = false;\n\n      if (this.localPackageLock) {\n        const { dependenciesLockPath } = this.plugin.settings;\n        const remotePackageLock = await this.plugin.bucketService.getFile(dependenciesLockPath);\n        if (remotePackageLock) {\n          const parsedRemotePackageLock = JSON.parse(remotePackageLock);\n          const lockDependencies = Object.fromEntries(\n            Object.entries(parsedRemotePackageLock.dependencies)\n              .filter((dependency) => dependency[1].dev !== true)\n          );\n          const localLockDependencies = Object.fromEntries(\n            Object.entries(this.localPackageLock.dependencies)\n              .filter((dependency) => dependency[1].dev !== true)\n          );\n\n          isDifferentPackageLock = JSON.stringify(lockDependencies)\n            !== JSON.stringify(localLockDependencies);\n        } else {\n          isDifferentPackageLock = true;\n        }\n      }\n      isDifferent = version !== this.localPackage.version\n        || isDifferentPackageJson\n        || isDifferentPackageLock;\n    }\n\n    return isDifferent;\n  }\n}\n\nmodule.exports = NodeJSRuntime;\n"],"file":"nodejs.js"}